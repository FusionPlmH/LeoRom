#!/sbin/sh
#
# wipe userdata and cache partition
#
OUTFD=$2
ZIP=$3
OUTFD=$2

if [ -n "$2" ];then
  readlink /proc/$$/fd/$OUTFD 2>/dev/null | grep /tmp >/dev/null
  if [ "$?" -eq "0" ]; then

    OUTFD=0

    for FD in `ls /proc/$$/fd`; do
      readlink /proc/$$/fd/$FD 2>/dev/null | grep pipe >/dev/null
      if [ "$?" -eq "0" ]; then
        ps | grep " 3 $FD " | grep -v grep >/dev/null
        if [ "$?" -eq "0" ]; then
          OUTFD=$FD
          break
        fi
      fi
    done
  fi
  ui_print() {
    echo -n -e "ui_print $1\n" >> /proc/self/fd/$OUTFD
    echo -n -e "ui_print\n" >> /proc/self/fd/$OUTFD
  }
else
  ui_print() {
    echo "$1"
  }
fi

ui_print() {
  echo -n -e "ui_print $1\n" > /proc/self/fd/$OUTFD
  echo -n -e "ui_print\n" > /proc/self/fd/$OUTFD
}


ui_print "========================================";
ui_print ">>> Leo ROM  FOTA<<<                    ";
ui_print "========================================";
ui_print ">>> FOTA S10 S10+<<<                    "; 
ui_print "========================================";
ui_print ">>> Android 10 <<<                      ";
ui_print "========================================";
ui_print ">>> By  Salt <<<                        ";
ui_print "========================================";
sleep 2.0

ui_print ">>> Check the ROM"

# Mount system
ui_print ">>> Mounting system..."

bp=/system_root/system/build.prop

mount /system
mount -o rw,remount /system
mount -o rw,remount /system /system
mount /system_root
mount -o rw,remount /system_root
mount -o rw,remount /system_root /system_root

ui_print ">>> Mounting data..."

mount /userdata
mount -o rw,remount /userdata
mount -o rw,remount /userdata /userdata
mount /data
mount -o rw,remount /data
mount -o rw,remount /data /data

cd /tmp
mkdir dap
cd dap
unzip -o "$ZIP"


sleep 3.0
# Clean files
ui_print ">>> update system ..."
sleep 1.0
# Clean files
ui_print ">>> Clean files..."
rm -rf /data/app/com.android.systemui*
rm -rf /data/data/com.android.systemui*
rm -rf /data/user/0/com.android.systemui*
rm -rf /data/user_de/0/com.android.systemui*

rm -f /data/dalvik-cache/arm/system@priv-app@SystemUI@SystemUI.apk@classes.dex
rm -f /data/dalvik-cache/arm/system@priv-app@SystemUI@SystemUI.apk@classes.vdex
rm -f /data/dalvik-cache/arm/system@priv-app@SystemUI@SystemUI.apk@classes.art
rm -f /data/dalvik-cache/arm64/system@priv-app@SystemUI@SystemUI.apk@classes.dex
rm -f /data/dalvik-cache/arm64/system@priv-app@SystemUI@SystemUI.apk@classes.vdex
rm -f /data/dalvik-cache/arm64/system@priv-app@SystemUI@SystemUI.apk@classes.art

rm -f /data/system/package_cache/1/SystemUI-16
rm -f /data/system/package_cache/1/SystemUI-65
rm -f /data/system/package_cache/1/SystemUI*

# Copy files
ui_print ">>> Copy files..."

cp -p -a -R /tmp/dap/system/* /system_root/system


sleep 5.0
ui_print ">>> Setting permissions..."

chmod -R 0755 /system_root/system/priv-app/SystemUI
chmod 0644 /system_root/system/priv-app/SystemUI/SystemUI.apk

sleep 10
echo "ro.leo.online.update.version=2" >> $bp

ui_print ">>> succeed"
# Cleanup
ui_print ""
sleep 0.6
ui_print ">>> Unloading system"
umount /system
umount /system_root
umount /userdata
umount /data
rm -rf /tmp/dap
sleep 5.0
ui_print ">>> System updated succeed!"
sleep 0.6
ui_print ">>> OK, Will reboot your phone!"
sleep 1.0

reboot recovery

exit 0

