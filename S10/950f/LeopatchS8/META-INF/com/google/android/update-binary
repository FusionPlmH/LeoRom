#!/sbin/sh
#
# wipe userdata and cache partition
#
OUTFD=$2
ZIP=$3
OUTFD=$2

if [ -n "$2" ];then
  readlink /proc/$$/fd/$OUTFD 2>/dev/null | grep /tmp >/dev/null
  if [ "$?" -eq "0" ]; then

    OUTFD=0

    for FD in `ls /proc/$$/fd`; do
      readlink /proc/$$/fd/$FD 2>/dev/null | grep pipe >/dev/null
      if [ "$?" -eq "0" ]; then
        ps | grep " 3 $FD " | grep -v grep >/dev/null
        if [ "$?" -eq "0" ]; then
          OUTFD=$FD
          break
        fi
      fi
    done
  fi
  ui_print() {
    echo -n -e "ui_print $1\n" >> /proc/self/fd/$OUTFD
    echo -n -e "ui_print\n" >> /proc/self/fd/$OUTFD
  }
else
  ui_print() {
    echo "$1"
  }
fi

ui_print() {
  echo -n -e "ui_print $1\n" > /proc/self/fd/$OUTFD
  echo -n -e "ui_print\n" > /proc/self/fd/$OUTFD
}


ui_print "========================================";
ui_print ">>> Leo ROM <<<                         ";
ui_print "========================================";
ui_print ">>> Galaxy S8/S8+/N8/S9/N9 <<<          "; 
ui_print "========================================";
ui_print ">>> Android 9 <<<                       ";
ui_print "========================================";
sleep 2.0

ui_print ">>> Check the ROM"

# Mount system
ui_print ">>> Mounting system..."


mount /system
mount -o rw,remount /system
mount -o rw,remount /system /system
mount /system_root
mount -o rw,remount /system_root
mount -o rw,remount /system_root /system_root

ui_print ">>> Mounting data..."

mount /userdata
mount -o rw,remount /userdata
mount -o rw,remount /userdata /userdata
mount /data
mount -o rw,remount /data
mount -o rw,remount /data /data

cd /tmp
mkdir dap
cd dap
unzip -o "$ZIP"


sleep 3.0

# Extract files
ui_print ">>> Extract files..."

rm -rf /data/app/com.topjohnwu.magisk*
rm -rf /data/data/com.topjohnwu.magisk*
rm -rf /data/user/0/com.topjohnwu.magisk*
rm -rf /data/user_de/0/com.topjohnwu.magisk*

rm -f /data/dalvik-cache/arm/system@app@MagiskManager@MagiskManager.apk@classes.dex
rm -f /data/dalvik-cache/arm/system@app@MagiskManager@MagiskManager.apk@classes.vdex
rm -f /data/dalvik-cache/arm/system@app@MagiskManager@MagiskManager.apk@classes.art
rm -f /data/dalvik-cache/arm64/system@app@MagiskManager@MagiskManager.apk@classes.dex
rm -f /data/dalvik-cache/arm64/system@app@MagiskManager@MagiskManager.apk@classes.vdex
rm -f /data/dalvik-cache/arm64/system@app@MagiskManager@MagiskManager.apk@classes.art

rm -f /data/system/package_cache/1/MagiskManager-16
rm -f /data/system/package_cache/1/MagiskManager-65
rm -f /data/system/package_cache/1/MagiskManager*

rm -f /system/app/MagiskManager/MagiskManager.apk
rm -rf /system/app/MagiskManager
rm -rf /system/app/MagiskManager*

rm -rf /data/app/com.android.systemui*
rm -rf /data/data/com.android.systemui*
rm -rf /data/user/0/com.android.systemui*
rm -rf /data/user_de/0/com.android.systemui*

rm -f /data/dalvik-cache/arm/system@priv-app@SystemUI@SystemUI.apk@classes.dex
rm -f /data/dalvik-cache/arm/system@priv-app@SystemUI@SystemUI.apk@classes.vdex
rm -f /data/dalvik-cache/arm/system@priv-app@SystemUI@SystemUI.apk@classes.art
rm -f /data/dalvik-cache/arm64/system@priv-app@SystemUI@SystemUI.apk@classes.dex
rm -f /data/dalvik-cache/arm64/system@priv-app@SystemUI@SystemUI.apk@classes.vdex
rm -f /data/dalvik-cache/arm64/system@priv-app@SystemUI@SystemUI.apk@classes.art

rm -f /data/system/package_cache/1/SystemUI-16
rm -f /data/system/package_cache/1/SystemUI-65
rm -f /data/system/package_cache/1/SystemUI*

rm -f /system/priv-app/SystemUI/SystemUI.apk
rm -rf /system/priv-app/SystemUI
rm -rf /system/priv-app/SystemUI*

# Copy files
ui_print ">>> Copy files..."

cp -r -a /tmp/dap/system/* /system
sleep 0.6
ui_print ">>> Set permissions"

chmod -R 0755 /system/app/MagiskManager;
chmod -R 0644 /system/app/MagiskManager/MagiskManager.apk;
chmod -R 0755 /system/priv-app/SystemUI;
chmod -R 0644 /system/priv-app/SystemUI/SystemUI.apk;
sleep 10
ui_print ">>> succeed"
# Cleanup
ui_print ""
sleep 0.6
ui_print ">>> Unloading system"
umount /system
umount /system_root
umount /userdata
umount /data
rm -rf /tmp/dap
sleep 5.0
ui_print ">>> System updated succeed!"
sleep 0.6
ui_print ">>> OK, Will reboot your phone!"
sleep 1.0

exit 0

